#+title: Streamlining creation of multi-panel paper figures with Python
#+date:<2023-02-18 Sat>
#+PROPERTY: header-args :eval never-export

Papers published on scientific journals usually have limited space, so we usually have to generate figures with multiple panels.
Within one figure, panels can be schematics (cartoons), example data (photos) and data analysis (plots).
Usually, we manually combine the panels into a single figure in an image editing software, which makes it hard to be version-controlled.
What's worse, the figures are subject to frequent update, which leads to:
1. difficulty in reverting to, or recovering part of the previous version;
2. repeated manual labour to combine panels;
3. arbitrary positioning of the panels and their labels.

Below, I show how to combine Python and Inkscape to streamline this process:
1. use ~matplotlib~ in Python to generate the spatial arrangement of panels and plot data in data panels;
2. (optional) use [[https://inkscape.org/][Inkscape]] to generate schematics;
3. use Python again to combine the Python output and the schematics, and generate panel labels (A, B, C...).

* Generating spatial arrangement and plots of data
For example, I want a 4-panel figure in a \(2 \times 2\) format, with the first being the schematics.
I prepare the spacial arrangement and plot the data within one script:
#+begin_src python
import matplotlib.pyplot as plt
# create the figure
fig, ax = plt.subplots(1, 2, figsize=(8,4))
# plot something on the second panel
x = list(range(4))
ax[1].scatter(x, x)
# save the figure (for now)
plt.savefig("my-path-to-the-figure.png", dpi=300)
#+end_src
The ~figsize~ argument in ~plt.subplots~ controls the width and the height of the figure, each in inches.
The ~dpi~ argument in ~plt.savefig~ controls the number of dots (pixels) per inch.
Combining the two settings, the resolution of the output figure should be \(2400 \times 1200\) pixels.

[[../../misc/coding/paper-figures-1.png]]

* Generating a schematics with Inkscape
Before drawing in Inkscape, we must set the page's size in the ~File >> Document properties...~ menu.
In our spatial arrangement, the height and the width of the schematics should be half of those of the whole figure.
The white space around the figure takes up about 20% of the width and height, so the page's width and height in inches should be \(8 \times 0.8 / 2 = 3.2\).
How to draw in Inkscape is beyond the scope of this post, but Inkscape includes a wonderful, interactive tutorial in the ~Help >> Tutorials~ menu.
After finishing the schematics, save it as an ~.svg~ file for future modification, and export to a ~.png~ file to merge with the figure from Python.
To export to PNG, find the ~File >> Export...~ menu and set the DPI to be 300 before exporting.

* Combining the schematics and the plots
Now the read the PNG file exported from Inkscape back to Python and plot in the first panel:
#+begin_src python
img = plt.imread("my-path-to-the-inscape-image.png")
ax[0].imshow(img) # you may try aspect="auto"
# hide the x and y axis
ax[0].axis("off")
#+end_src

The last thing is to automatically add the labels A, B, C... to the panels, which is adapted from [[https://stackoverflow.com/questions/25543978/matplotlib-annotate-subplots-in-a-figure-with-a-b-c][here]]:
#+begin_src python
import string
for n, axis in enumerate(ax): # ax.flat if `ax` is an array
    axis.text(
        -0.05,
        1.05,
        string.ascii_uppercase[n],
        transform=axis.transAxes,
        size=20,
        weight="bold",
    )
#+end_src
And don't forget to save the figure:
#+begin_src python
plt.savefig("my-path-to-the-figure.png", dpi=300)
#+end_src
Now we can place both the SVG file from Inkscape and the Python under version control!
There's no need to place the generated PNG file under version control, because we'll get it back once we run the Python code again.

One issue of this workflow is that the label of the schematics panel is not placed at the same level of other panel labels.
This is because the size we used in the Inkscape section, \(3.2 \times 3.2\) inches, does not exactly match the size of the panel.
To solve this, we can either (1) fine-tune the size in Inkscape or (2) set ~aspect="auto"~ when calling ~ax[0].imshow()~, or (3) adjust the whitespace between subplots using ~plt.subplots_adjust()~.

[[../../misc/coding/paper-figures-2.png]]
